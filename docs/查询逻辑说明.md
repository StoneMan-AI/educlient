# 试题查询逻辑说明

## 查询条件

查询试题需要三个条件：
1. **年级**（必选）
2. **学科**（必选）
3. **知识点**（必选）

## 查询逻辑

### 1. 年级 → 学科列表

**查询逻辑**：只显示在该年级下有**已发布题目**的学科

```sql
SELECT DISTINCT s.id, s.name, s.code 
FROM subjects s
INNER JOIN questions q ON q.subject_id = s.id
WHERE q.grade_id = $1 AND q.status = '已发布'
```

**说明**：
- 如果某个学科在该年级下没有已发布的题目，则不会显示在学科列表中
- 例如：如果小学一年级只有数学有已发布的题目，那么学科列表就只会显示数学

### 2. 年级 + 学科 → 知识点列表

**查询逻辑**：只显示在该年级+学科下有**已发布题目**的知识点

```sql
SELECT DISTINCT kp.id, kp.name, kp.description
FROM knowledge_points kp
INNER JOIN questions q ON q.knowledge_point_id = kp.id
WHERE kp.grade_id = $1 
  AND kp.subject_id = $2 
  AND kp.is_active = TRUE 
  AND q.status = '已发布'
```

**说明**：
- 只显示有已发布题目的知识点
- 同时要求知识点状态为 `is_active = TRUE`

### 3. 最终查询试题

**查询条件**：
- `grade_id` = 年级ID
- `subject_id` = 学科ID
- `knowledge_point_id` = 知识点ID
- `status = '已发布'` - 题目状态必须是已发布

## 为什么只有数学？

如果选择了"小学一年级"后，学科列表只有"数学"，说明：

1. **数据库中只有数学学科有已发布的题目**
2. 其他学科（语文、英语等）可能：
   - 没有题目数据
   - 有题目但状态不是"已发布"（可能是"未处理"、"已标注"、"已审核"）

## 解决方案

### 方案1：显示所有学科（即使没有题目）

如果需要显示所有学科，即使没有题目也显示，可以修改查询逻辑：

```javascript
// 修改 backend/routes/subject.js
// 从 INNER JOIN 改为 LEFT JOIN，并添加条件
const result = await pool.query(
  `SELECT DISTINCT s.id, s.name, s.code 
   FROM subjects s
   LEFT JOIN questions q ON q.subject_id = s.id AND q.grade_id = $1 AND q.status = '已发布'
   WHERE s.id IN (SELECT DISTINCT subject_id FROM questions WHERE grade_id = $1)
      OR s.id IN (SELECT id FROM subjects WHERE code IN ('MATH', 'CHINESE', 'ENGLISH'))
   ORDER BY s.name`,
  [grade_id]
)
```

### 方案2：检查题目数据状态

检查数据库中其他学科的题目状态：

```sql
-- 查看小学一年级所有学科的题目情况
SELECT 
  s.name as subject_name,
  q.status,
  COUNT(*) as question_count
FROM subjects s
LEFT JOIN questions q ON q.subject_id = s.id AND q.grade_id = 1
GROUP BY s.name, q.status
ORDER BY s.name;
```

### 方案3：修改题目状态

如果其他学科有题目但未发布，需要将题目状态改为"已发布"：

```sql
-- 将小学一年级所有学科的题目状态改为已发布
UPDATE questions 
SET status = '已发布'
WHERE grade_id = 1 
  AND status != '已发布';
```

## 当前查询逻辑的设计原因

**优点**：
- 只显示有数据的选项，避免用户选择后没有结果
- 用户体验更好，不会出现"选择了但没有题目"的情况

**缺点**：
- 如果某个学科暂时没有题目，用户无法知道该学科存在
- 需要先录入题目数据，才能在选择器中看到

## 建议

1. **如果数据还在录入中**：保持当前逻辑，只显示有题目的学科
2. **如果数据已完整**：可以改为显示所有学科，但需要在前端提示"该学科暂无题目"
3. **如果希望显示所有学科**：可以修改查询逻辑，使用LEFT JOIN并显示所有学科

