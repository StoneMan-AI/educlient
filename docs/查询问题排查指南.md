# 查询问题排查指南

## 问题：选择年级、学科、知识点后，显示"找到 0 道试题"

### 可能原因

1. **题目状态不是"已发布"**
   - 题目状态可能是："未处理"、"已标注"、"已审核"
   - 查询条件要求 `status = '已发布'`

2. **数据不存在**
   - 该年级、学科、知识点下确实没有题目

3. **ID不匹配**
   - 前端传递的ID与数据库中的ID不一致

## 排查步骤

### 步骤1：使用调试API检查

访问调试接口（需要在服务器上启用调试）：

```
https://educlient.adddesigngroup.com/api/debug/check-questions?grade_id=1&subject_id=1&knowledge_point_id=1
```

这会返回：
- 题目总数
- 各状态的题目数量
- 题目列表
- 知识点信息

### 步骤2：直接查询数据库

```sql
-- 1. 检查是否有任何题目（不限制状态）
SELECT COUNT(*) 
FROM questions 
WHERE grade_id = 1 
  AND subject_id = 1 
  AND knowledge_point_id = 1;

-- 2. 检查各状态的题目数量
SELECT status, COUNT(*) as count
FROM questions
WHERE grade_id = 1 
  AND subject_id = 1 
  AND knowledge_point_id = 1
GROUP BY status;

-- 3. 查看具体的题目信息
SELECT id, status, grade_id, subject_id, knowledge_point_id, title
FROM questions
WHERE grade_id = 1 
  AND subject_id = 1 
  AND knowledge_point_id = 1
LIMIT 10;
```

### 步骤3：查看后端日志

```bash
# 查看PM2日志
pm2 logs educlient-backend --lines 50

# 查看查询参数和结果
# 应该能看到类似这样的日志：
# 查询试题参数: { grade_id: 1, subject_id: 1, knowledge_point_id: 1 }
# 查询结果: { total: 0, questions_count: 0 }
# 找到题目但状态不是"已发布": [...]
```

## 解决方案

### 方案1：修改题目状态为"已发布"

如果题目存在但状态不是"已发布"：

```sql
-- 将指定条件的题目状态改为已发布
UPDATE questions 
SET status = '已发布'
WHERE grade_id = 1 
  AND subject_id = 1 
  AND knowledge_point_id = 1
  AND status != '已发布';

-- 验证更新结果
SELECT COUNT(*) 
FROM questions 
WHERE grade_id = 1 
  AND subject_id = 1 
  AND knowledge_point_id = 1
  AND status = '已发布';
```

### 方案2：临时放宽查询条件（仅用于测试）

如果需要临时查看所有状态的题目，可以修改查询逻辑（不推荐生产环境）：

```javascript
// 在 backend/routes/question.js 中
// 将 status = '已发布' 改为可选的
WHERE q.grade_id = $1 
  AND q.subject_id = $2 
  AND q.knowledge_point_id = $3
  AND (q.status = '已发布' OR $4 = true)  -- $4 为查询参数 include_all_status
```

### 方案3：检查前端传递的参数

在浏览器开发者工具中查看网络请求：

1. 打开开发者工具（F12）
2. 切换到 Network 标签
3. 执行查询操作
4. 查看 `/api/questions/search` 请求
5. 检查 Query Parameters 中的参数是否正确

## 常见问题

### Q1: 为什么学科和知识点列表能显示，但查询不到题目？

**A**: 学科和知识点列表的查询逻辑是：
- 显示**有已发布题目**的学科/知识点
- 但查询时可能题目状态被修改了，或者查询的参数ID不匹配

### Q2: 如何确认ID是否正确？

**A**: 检查步骤：
1. 在浏览器控制台查看网络请求的参数
2. 在数据库中查询对应的ID：
   ```sql
   SELECT id, name FROM grades WHERE name LIKE '%小学一年级%';
   SELECT id, name FROM subjects WHERE name LIKE '%数学%';
   SELECT id, name FROM knowledge_points WHERE name LIKE '%知识点名称%';
   ```

### Q3: 如何批量更新题目状态？

**A**: 
```sql
-- 批量将指定年级的所有题目改为已发布
UPDATE questions 
SET status = '已发布'
WHERE grade_id = 1 
  AND status != '已发布';

-- 或者批量更新所有题目
UPDATE questions 
SET status = '已发布'
WHERE status IN ('未处理', '已标注', '已审核');
```

## 快速诊断命令

创建一个诊断SQL脚本：

```sql
-- 诊断查询
WITH params AS (
  SELECT 1 as grade_id, 1 as subject_id, 1 as knowledge_point_id
)
SELECT 
  '题目总数' as 检查项,
  COUNT(*) as 数量
FROM questions q, params p
WHERE q.grade_id = p.grade_id 
  AND q.subject_id = p.subject_id 
  AND q.knowledge_point_id = p.knowledge_point_id

UNION ALL

SELECT 
  '已发布题目' as 检查项,
  COUNT(*) as 数量
FROM questions q, params p
WHERE q.grade_id = p.grade_id 
  AND q.subject_id = p.subject_id 
  AND q.knowledge_point_id = p.knowledge_point_id
  AND q.status = '已发布'

UNION ALL

SELECT 
  status as 检查项,
  COUNT(*) as 数量
FROM questions q, params p
WHERE q.grade_id = p.grade_id 
  AND q.subject_id = p.subject_id 
  AND q.knowledge_point_id = p.knowledge_point_id
GROUP BY status;
```

