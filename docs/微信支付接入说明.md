# 微信支付接入说明

## 当前接入的支付类型

**微信支付 Native支付（扫码支付）**，而非服务号API。

### 区别说明

| 特性 | Native支付（扫码支付） | 服务号API（JSAPI/H5） |
|------|----------------------|---------------------|
| 使用场景 | PC网站，生成二维码让用户扫码 | 公众号内支付，或H5页面支付 |
| API类型 | 微信支付商户平台API | 微信公众平台API |
| 支付方式 | 用户用微信扫描二维码 | 用户在公众号内直接支付 |
| 配置要求 | 需要商户号(MCHID)和API密钥 | 需要服务号AppID和商户号 |
| 回调格式 | XML格式 | XML格式 |
| 适用场景 | 当前项目（PC网站） | 公众号内嵌网页 |

### 为什么选择Native支付？

1. **项目场景**：这是一个PC网站，用户通过浏览器访问
2. **支付流程**：用户选择题目后，在PC上生成二维码，用手机微信扫码支付
3. **技术实现**：使用二维码支付更符合当前的项目架构

## 环境变量配置

在 `backend/.env` 中配置：

```env
# 微信支付配置（Native支付）
WECHAT_APPID=wx1234567890abcdef        # 微信支付分配的AppID（不是服务号AppID）
WECHAT_MCHID=1234567890                 # 商户号
WECHAT_KEY=your-api-key-32-characters   # API密钥（32位）
WECHAT_NOTIFY_URL=https://yourdomain.com/api/vip/payment-callback  # 支付回调地址
```

## 接入步骤

### 1. 注册微信支付商户

1. 访问 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 注册并申请成为商户
3. 获取商户号(MCHID)
4. 设置API密钥（在商户平台-账户中心-API安全中设置）

### 2. 配置支付参数

在微信支付商户平台配置：
- **支付授权目录**：设置你的网站域名
- **支付回调URL**：设置 `WECHAT_NOTIFY_URL`
- **API密钥**：生成32位密钥，设置到 `WECHAT_KEY`

### 3. 安装依赖

```bash
cd backend
npm install xml2js
```

### 4. 使用支付工具

已创建 `backend/utils/wechatPayment.js` 工具类，包含：

- `createNativeOrder()` - 创建Native支付订单，生成二维码
- `queryOrder()` - 查询订单状态
- `verifyPaymentCallback()` - 验证支付回调签名
- `parseCallbackXml()` - 解析回调XML

### 5. 集成到路由

在 `backend/routes/vip.js` 中，将TODO部分替换为：

```javascript
import { createNativeOrder } from '../utils/wechatPayment.js'

// 在获取支付二维码的路由中
const paymentResult = await createNativeOrder({
  out_trade_no: orderNo,
  total_fee: order.amount,
  body: 'VIP充值',
  spbill_create_ip: req.ip || req.connection.remoteAddress
})

res.json({
  success: true,
  qr_code_url: paymentResult.code_url  // 二维码链接，可直接转换为二维码图片
})
```

## 二维码生成

获取到 `code_url` 后，需要将其转换为二维码图片。可以使用：

1. **前端生成**：使用 `qrcode` 库
2. **后端生成**：使用 `qrcode` 或 `qr-image` 库
3. **第三方服务**：使用在线二维码生成API

示例（前端生成）：

```javascript
import QRCode from 'qrcode'

const qrCodeDataUrl = await QRCode.toDataURL(code_url)
// 显示二维码图片
```

## 支付回调处理

支付回调路由已创建在 `backend/routes/vip.js` 中，需要完善：

```javascript
import { parseCallbackXml, verifyPaymentCallback } from '../utils/wechatPayment.js'

router.post('/payment-callback', express.raw({ type: 'application/xml' }), async (req, res, next) => {
  try {
    const xmlData = req.body.toString()
    const params = await parseCallbackXml(xmlData)
    
    // 验证签名
    if (!verifyPaymentCallback(params)) {
      return res.status(400).send('<xml><return_code><![CDATA[FAIL]]></return_code></xml>')
    }
    
    // 验证订单状态
    if (params.return_code === 'SUCCESS' && params.result_code === 'SUCCESS') {
      // 更新订单状态
      await pool.query(
        `UPDATE orders SET status = 'paid', wechat_transaction_id = $1, paid_at = NOW() 
         WHERE order_no = $2`,
        [params.transaction_id, params.out_trade_no]
      )
    }
    
    res.send('<xml><return_code><![CDATA[SUCCESS]]></return_code></xml>')
  } catch (error) {
    next(error)
  }
})
```

## 如果要用服务号API

如果将来需要改为服务号内的支付（JSAPI支付），需要：

1. **申请服务号**：注册微信服务号
2. **配置网页授权**：设置授权域名
3. **获取用户OpenID**：通过网页授权获取用户OpenID
4. **调用JSAPI支付**：使用OpenID调用JSAPI统一下单接口
5. **前端调用支付**：使用微信JS-SDK调用支付接口

这需要完全不同的实现方式，适用于公众号内嵌网页的场景。

## 注意事项

1. **安全**：API密钥必须保密，不要提交到代码仓库
2. **HTTPS**：生产环境必须使用HTTPS
3. **回调URL**：必须在微信支付商户平台配置
4. **金额单位**：注意金额单位是"分"，不是"元"
5. **订单号唯一性**：商户订单号必须唯一

## 测试

微信支付提供沙箱环境用于测试：

- 沙箱API地址：`https://api.mch.weixin.qq.com/sandboxnew/pay/unifiedorder`
- 需要先获取沙箱密钥：`https://api.mch.weixin.qq.com/sandboxnew/pay/getsignkey`

