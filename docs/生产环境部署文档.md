# 生产环境部署文档

## 前置要求

- 服务器：Linux（Ubuntu 20.04+ / CentOS 7+）
- Node.js：>= 18.0.0
- PostgreSQL：>= 12.0
- Nginx：>= 1.18.0
- 域名已解析到服务器IP
- SSL证书已准备（推荐使用Let's Encrypt）

## 一、服务器环境准备

### 1.1 更新系统

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 1.2 安装Node.js

```bash
# 使用NodeSource安装Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

### 1.3 安装PostgreSQL

```bash
# Ubuntu/Debian
sudo apt install postgresql postgresql-contrib -y

# CentOS/RHEL
sudo yum install postgresql-server postgresql-contrib -y
sudo postgresql-setup initdb
sudo systemctl enable postgresql
sudo systemctl start postgresql
```

### 1.4 安装Nginx

```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS/RHEL
sudo yum install nginx -y

# 启动Nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```

### 1.5 安装PM2（进程管理）

```bash
sudo npm install -g pm2
```

## 二、数据库配置

### 2.1 创建数据库和用户

```bash
# 切换到postgres用户
sudo -u postgres psql

# 在PostgreSQL命令行中执行
# 注意：数据库edupro_db已存在，如果不存在则创建
CREATE DATABASE edupro_db;
CREATE USER educlient_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE edupro_db TO educlient_user;
\q
```

### 2.2 执行数据库脚本

```bash
# 创建项目目录
mkdir -p /var/www/educlient
cd /var/www/educlient

# 上传项目文件（或使用git clone）
# git clone your-repo-url .

# 注意：基础表结构已存在，只需执行扩展表结构
# 执行扩展表结构
sudo -u postgres psql -d edupro_db -f database/schema_extension.sql
```

## 三、后端部署

### 3.1 创建后端目录

```bash
cd /var/www/educlient/backend
```

### 3.2 安装依赖

```bash
npm install --production
```

### 3.3 配置环境变量

```bash
# 创建.env文件
nano .env
```

添加以下内容：

```env
# 数据库配置（方式1：使用连接字符串）
# 注意：如果密码包含特殊字符，需要进行URL编码
# 例如：密码 p@ss#rd 应该写成 p%40ss%23rd
DATABASE_URL=postgresql://educlient_user:12345@localhost:5432/edupro_db

# 数据库配置（方式2：使用独立变量，推荐用于密码包含特殊字符的情况）
# 如果使用方式2，请注释掉上面的DATABASE_URL
# DB_HOST=localhost
# DB_PORT=5432
# DB_NAME=edupro_db
# DB_USER=educlient_user
# DB_PASSWORD=your_password_here

# JWT密钥（生成随机字符串）
JWT_SECRET=jkf8713kjgfjhk34298dfsklj390rjrfw

# 微信支付配置
WECHAT_APPID=wx1234567890abcdef
WECHAT_MCHID=1234567890
WECHAT_KEY=your_32_characters_api_key
WECHAT_NOTIFY_URL=https://educlient.adddesigngroup.com/api/vip/payment-callback

# 服务器配置
PORT=3005
NODE_ENV=production

# 文件上传目录（图片存储路径）
# 注意：图片实际存放在 /opt/EduPro/backend/src/uploads，不在项目目录下
UPLOAD_DIR=/opt/EduPro/backend/src/uploads
```

保存并退出：`Ctrl+X`，然后 `Y`，然后 `Enter`

**重要提示**：
- 如果密码包含特殊字符（如 `@`, `#`, `%`, `&` 等），需要对密码进行URL编码
- 例如：密码 `p@ssw#rd` 应该编码为 `p%40ssw%23rd`
- 可以使用在线URL编码工具进行编码

### 3.3.1 验证环境变量

```bash
# 检查环境变量是否正确加载
cd /var/www/educlient/backend
node check-env.js

# 或者手动测试
node -e "require('dotenv').config(); console.log(process.env.DATABASE_URL)"
```

### 3.4 创建上传目录

```bash
mkdir -p /var/www/educlient/uploads
chmod 755 /var/www/educlient/uploads
```

### 3.5 使用PM2启动后端服务

```bash
# 项目已包含PM2配置文件 backend/ecosystem.config.cjs
# 注意：使用.cjs扩展名以支持ES模块项目（package.json中有"type": "module"）
# 如需修改配置，编辑该文件即可

# 创建日志目录（如果配置文件中使用绝对路径，需要创建）
sudo mkdir -p /var/log/educlient
sudo chown $USER:$USER /var/log/educlient

# 或者使用项目根目录下的logs目录
mkdir -p /var/www/educlient/backend/logs

# 进入后端目录
cd /var/www/educlient/backend

# 启动服务（使用项目中的配置文件）
pm2 start ecosystem.config.cjs

# 设置开机自启
pm2 startup
pm2 save
```

### 3.6 验证后端服务

```bash
# 查看服务状态
pm2 status

# 查看日志
pm2 logs educlient-backend

# 测试API（在另一个终端）
curl http://localhost:3005/api/grades
```

## 四、前端部署

### 4.1 进入前端目录

```bash
cd /var/www/educlient/frontend
```

### 4.2 安装依赖

```bash
npm install
```

### 4.3 配置生产环境变量

```bash
# 创建.env.production文件
nano .env.production
```

添加以下内容：

```env
VITE_API_BASE_URL=https://educlient.adddesigngroup.com/api
```

### 4.4 构建前端

```bash
npm run build
```

构建完成后，会在 `dist` 目录生成静态文件。

### 4.5 配置Nginx

```bash
# 创建Nginx配置文件
sudo nano /etc/nginx/sites-available/educlient
```

添加以下配置：

```nginx
# 前端静态文件
server {
    listen 80;
    server_name educlient.adddesigngroup.com;
    
    root /var/www/educlient/frontend/dist;
    index index.html;

    # 上传文件（图片）静态服务
    # 注意：必须在 location / 之前，否则会被 location / 捕获
    # 注意：图片实际存放在 /opt/EduPro/backend/src/uploads，不在项目目录下
    # 重要：使用精确匹配或前缀匹配，确保优先于 location /
    location ^~ /uploads/ {
        alias /opt/EduPro/backend/src/uploads/;
        expires 30d;
        add_header Cache-Control "public";
        # 允许跨域（如果需要）
        add_header Access-Control-Allow-Origin *;
        # 允许访问图片文件
        access_log off;
    }

    # 前端路由支持（SPA）
    # 注意：必须在 /uploads/ 之后，避免捕获上传文件请求
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 方式2：代理到后端（如果方式1不行，使用这个）
    # location /uploads {
    #     proxy_pass http://localhost:3005;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }

    # API代理到后端
    location /api {
        proxy_pass http://localhost:3005;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

保存后创建软链接：

```bash
sudo ln -s /etc/nginx/sites-available/educlient /etc/nginx/sites-enabled/
```

### 4.6 配置SSL证书（Let's Encrypt）

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 申请SSL证书
sudo certbot --nginx -d educlient.adddesigngroup.com
sudo certbot --nginx -d educlient.adddesigngroup.com

# 按照提示输入邮箱和同意条款
# 选择是否重定向HTTP到HTTPS（推荐选择2：重定向）
```

Certbot会自动更新Nginx配置。

### 4.7 测试Nginx配置

```bash
# 测试配置语法
sudo nginx -t

# 如果测试通过，重载Nginx
sudo systemctl reload nginx
```

## 五、防火墙配置

### 5.1 配置UFW（Ubuntu）

```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 5.2 配置firewalld（CentOS）

```bash
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

## 六、服务验证

### 6.1 检查服务状态

```bash
# 检查PM2服务
pm2 status

# 检查Nginx服务
sudo systemctl status nginx

# 检查PostgreSQL服务
sudo systemctl status postgresql
```

### 6.2 测试API

```bash
# 测试后端API
curl https://educlient.adddesigngroup.com/api/grades

# 应该返回JSON数据
```

### 6.3 访问网站

在浏览器中访问：`https://educlient.adddesigngroup.com`

## 七、定期任务配置

### 7.1 配置SSL证书自动续期

```bash
# Certbot已自动配置定时任务，验证一下
sudo certbot renew --dry-run
```

### 7.2 配置日志轮转

```bash
# 创建日志轮转配置
sudo nano /etc/logrotate.d/educlient
```

添加以下内容：

```
/var/log/educlient/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

## 八、监控和维护

### 8.1 查看服务日志

```bash
# PM2日志
pm2 logs educlient-backend

# Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# Nginx访问日志
sudo tail -f /var/log/nginx/access.log
```

### 8.2 重启服务

```bash
# 重启后端
pm2 restart educlient-backend

# 重启Nginx
sudo systemctl restart nginx

# 重启PostgreSQL
sudo systemctl restart postgresql
```

### 8.3 更新代码

```bash
# 进入项目目录
cd /var/www/educlient

# 拉取最新代码（如果使用git）
# git pull origin main

# 更新后端依赖
cd backend
npm install --production
pm2 restart educlient-backend

# 更新前端
cd ../frontend
npm install
npm run build
# Nginx会自动使用新的dist目录
```

## 九、安全配置

### 9.1 设置文件权限

```bash
# 设置项目目录权限
sudo chown -R www-data:www-data /var/www/educlient
sudo chmod -R 755 /var/www/educlient

# 设置图片目录权限（注意：图片目录在 /opt/EduPro/backend/src/uploads）
sudo chmod -R 755 /opt/EduPro/backend/src/uploads
# 如果需要，确保Nginx可以读取
# sudo chown -R www-data:www-data /opt/EduPro/backend/src/uploads
```

### 9.2 配置PostgreSQL访问限制

```bash
# 编辑PostgreSQL配置
sudo nano /etc/postgresql/12/main/pg_hba.conf

# 确保只允许本地连接
# 找到类似这样的行，确保只允许本地：
local   all             all                                     peer
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5

# 重启PostgreSQL
sudo systemctl restart postgresql
```

### 9.3 配置.env文件权限

```bash
# 确保.env文件只能被所有者读取
chmod 600 /var/www/educlient/backend/.env
```

## 十、性能优化

### 10.1 配置Nginx缓存

在Nginx配置中添加：

```nginx
# 在http块中添加
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m use_temp_path=off;

# 在location /api中添加
proxy_cache api_cache;
proxy_cache_valid 200 60m;
proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
proxy_cache_background_update on;
```

### 10.2 配置Gzip压缩

在Nginx配置中添加：

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;
```

## 十一、故障排查

### 11.1 服务无法启动

```bash
# 检查PM2日志
pm2 logs educlient-backend --err

# 检查端口是否被占用
sudo netstat -tlnp | grep 3005

# 检查环境变量（使用项目中的检查脚本）
cd /var/www/educlient/backend
node check-env.js

# 或者手动检查
node -e "import('dotenv').then(d => { d.default.config(); console.log('DATABASE_URL:', process.env.DATABASE_URL) })"
```

### 11.1.1 数据库连接错误："client password must be a string"

如果遇到此错误，请检查：

```bash
# 1. 检查.env文件是否存在且格式正确
cat /var/www/educlient/backend/.env | grep DATABASE_URL

# 2. 验证密码是否正确（注意特殊字符需要URL编码）
# 例如：密码包含@需要写成%40

# 3. 测试数据库连接
psql -h localhost -U educlient_user -d edupro_db

# 4. 如果密码包含特殊字符，重新配置DATABASE_URL
# 方式1：使用URL编码的密码
# DATABASE_URL=postgresql://user:encoded_password@host:port/db

# 方式2：使用独立的环境变量（推荐）
# 在.env文件中添加：
# DB_HOST=localhost
# DB_PORT=5432
# DB_NAME=edupro_db
# DB_USER=educlient_user
# DB_PASSWORD=your_password_here
# 然后删除或注释掉DATABASE_URL
```

### 11.2 数据库连接失败

```bash
# 测试数据库连接
psql -h localhost -U educlient_user -d edupro_db

# 检查PostgreSQL是否运行
sudo systemctl status postgresql

# 查看PostgreSQL日志
sudo tail -f /var/log/postgresql/postgresql-12-main.log
```

### 11.3 Nginx 502错误

```bash
# 检查后端服务是否运行
pm2 status

# 检查后端日志
pm2 logs educlient-backend

# 测试后端API
curl http://localhost:3005/api/grades
```

### 11.4 静态文件404

```bash
# 检查dist目录是否存在
ls -la /var/www/educlient/frontend/dist

# 检查Nginx配置中的root路径
sudo nginx -T | grep root

# 检查文件权限
ls -la /var/www/educlient/frontend/dist

# 如果遇到 /vite.svg 404错误
# 这是正常的，因为已移除了vite.svg的引用
# 如果仍有404，需要重新构建前端：
cd /var/www/educlient/frontend
npm run build
# 然后重载Nginx
sudo systemctl reload nginx
```

## 十二、备份策略

### 12.1 数据库备份

```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-database.sh
```

添加以下内容：

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/educlient"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
pg_dump -U educlient_user edupro_db > $BACKUP_DIR/edupro_db_$DATE.sql
# 保留最近7天的备份
find $BACKUP_DIR -name "edupro_db_*.sql" -mtime +7 -delete
```

设置执行权限：

```bash
sudo chmod +x /usr/local/bin/backup-database.sh
```

### 12.2 配置定时备份

```bash
# 编辑crontab
sudo crontab -e

# 添加每天凌晨2点备份
0 2 * * * /usr/local/bin/backup-database.sh
```

## 部署检查清单

- [ ] 服务器环境已准备（Node.js, PostgreSQL, Nginx）
- [ ] 数据库已创建并执行脚本
- [ ] 后端环境变量已配置
- [ ] 后端服务已启动（PM2）
- [ ] 前端已构建
- [ ] Nginx已配置并重载
- [ ] SSL证书已配置
- [ ] 防火墙已配置
- [ ] 服务已验证可访问
- [ ] 日志轮转已配置
- [ ] 备份策略已配置
- [ ] 文件权限已正确设置

## 注意事项

1. **安全性**：
   - 所有密码使用强密码
   - .env文件权限设置为600
   - 定期更新系统和依赖包

2. **性能**：
   - 根据服务器配置调整PM2实例数
   - 配置Nginx缓存和Gzip压缩
   - 监控服务器资源使用情况

3. **维护**：
   - 定期检查日志
   - 定期备份数据库
   - 定期更新依赖包（注意测试兼容性）

4. **监控**：
   - 建议配置监控工具（如PM2 Plus、Grafana等）
   - 设置告警通知

---

**部署完成后，请访问网站进行功能测试，确保所有功能正常。**

